<%- include ('../partials/header') %>
<%- include ('../partials/menu') %>

<script>
    // Array to store the count of matching attributes for each row
    const matchingTags = [];

    // Function to trigger the comparison
    async function compareData(loggedInUser) {
        try {
            // Fetch data from the server using AJAX or fetch API
            const response = await fetch('http://localhost:3000/api/getUserData');
            const userData = await response.json();
            // console.log(userData); //testing purposes

            // Find the logged-in user in the data
            const loggedInUsername = userData.find(user => user.username === loggedInUser.username);
            console.log(loggedInUsername);

            // Loop through each row of the table
            userData.forEach(row => {
                if (row.username !== loggedInUsername) {
                    // Compare attributes and count matches
                    const rowAsString = JSON.stringify(row);
                    findAndDisplayMatches(rowAsString, loggedInUser);
                    // console.log('User:', loggedInUser) // testing purposes
                }
            });

        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Function to identify and display users that match
    function findAndDisplayMatches(user1, user2) {
        console.log('Row 1:', user1);
        console.log('Row 2:', user2);

        // Parse the JSON strings
        const parsedUser1 = JSON.parse(user1);
        const parsedUser2 = JSON.parse(user2);

        // Compare ski/board and mountain preferences
        if (parsedUser1.ski_or_board === parsedUser2.ski_or_board && parsedUser1.mtn_name === parsedUser2.mtn_name) {
            console.log('Match found:', parsedUser1.username);

            const matchedList = document.getElementById('matchedList');

            // Display matched keys with contact information
            if(parsedUser1.username !== parsedUser2.username)
            {
                const listItem = document.createElement('li');
                listItem.textContent = `${parsedUser1.username} [Contact: ${parsedUser1.username}@colorado.edu]`;
                matchedList.appendChild(listItem);
            }
        } else {
            console.log('No match found.');
        }
    }

</script>


<body>
    <h2>Discover</h2>
    <p>Find your ski/snowboarding partners! You'll be matched based on your ski/board preference as well as your location preference. 
        Click on the button below to see their name and contact email. Happy trails!</p>

    <!-- Button to trigger the comparison -->
    <button onclick="compareData('<%= JSON.stringify(loggedInUser) %>')">Find Ski/Board Partners</button>

    <!-- Display area for matched users -->
    <div id="matchedUsers">
        <h2>Matched Users</h2>
        <ul id="matchedList"></ul>
    </div>
</body>
</html>
